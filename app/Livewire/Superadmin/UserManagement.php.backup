<?php

namespace App\Livewire\Superadmin;

use Livewire\Component;
use Livewire\WithPagination;
use App\Models\User;
use App\Models\Employee;
use App\Models\Dosen;
use Spatie\Permission\Models\Role;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\DB;
use Spatie\Activitylog\Facades\LogActivity;

class UserManagement extends Component
{
    use WithPagination;

    public $search = '';
    public $selectedRole = '';
    public $showModal = false;
    public $editMode = false;
    public $userId;
    
    // Form properties
    public $name = '';
    public $email = '';
    public $password = '';
    public $password_confirmation = '';
    public $selectedRoles = [];
    public $userToDelete;
    public $showDeleteModal = false;
    public $showImportModal = false;
    public $importProgress = 0;
    public $importResults = [];
    public $importCounts = [];

    protected $paginationTheme = 'tailwind';

    public function rules()
    {
        $rules = [
            'name' => 'required|string|max:255',
            'email' => ['required', 'string', 'email', 'max:255', 'regex:/^[a-zA-Z0-9._%+-]+@usbypkp\.ac\.id$/'],
            'selectedRoles' => 'required|array|min:1',
            'selectedRoles.*' => 'exists:roles,name'
        ];

        if ($this->editMode) {
            $rules['email'][] = Rule::unique('users')->ignore($this->userId);
            $rules['password'] = 'nullable|string|min:8|confirmed';
        } else {
            $rules['email'][] = 'unique:users';
            $rules['password'] = 'required|string|min:8|confirmed';
        }

        return $rules;
    }

    public function updatedSearch()
    {
        $this->resetPage();
    }

    public function updatedSelectedRole()
    {
        $this->resetPage();
    }

    public function resetFilters()
    {
        $this->search = '';
        $this->selectedRole = '';
        $this->resetPage();
    }

    public function create()
    {
        $this->resetForm();
        $this->editMode = false;
        $this->showModal = true;
    }

    public function edit($userId)
    {
        $user = User::findOrFail($userId);
        $this->userId = $user->id;
        $this->name = $user->name;
        $this->email = $user->email;
        $this->selectedRoles = $user->roles->pluck('name')->toArray();
        $this->editMode = true;
        $this->showModal = true;
    }

    public function save()
    {
        $this->validate();

        try {
            if ($this->editMode) {
                $user = User::findOrFail($this->userId);
                $oldData = $user->toArray();
                $oldRoles = $user->roles->pluck('name')->toArray();
                
                $user->update([
                    'name' => $this->name,
                    'email' => $this->email,
                    'password' => $this->password ? Hash::make($this->password) : $user->password,
                ]);
                
                // Sync roles
                $user->syncRoles($this->selectedRoles);
                
                // Log activity
                activity('user_management')
                    ->causedBy(auth()->user())
                    ->performedOn($user)
                    ->withProperties([
                        'old_data' => $oldData,
                        'new_data' => $user->fresh()->toArray(),
                        'old_roles' => $oldRoles,
                        'new_roles' => $this->selectedRoles,
                    ])
                    ->log('User updated');
                    
                $message = 'Pengguna berhasil diperbarui!';
            } else {
                $user = User::create([
                    'name' => $this->name,
                    'email' => $this->email,
                    'password' => Hash::make($this->password),
                    'email_verified_at' => now(),
                ]);
                
                // Sync roles
                $user->syncRoles($this->selectedRoles);
                
                // Log activity
                activity('user_management')
                    ->causedBy(auth()->user())
                    ->performedOn($user)
                    ->withProperties([
                        'user_data' => $user->toArray(),
                        'assigned_roles' => $this->selectedRoles,
                    ])
                    ->log('User created');
                    
                $message = 'Pengguna berhasil dibuat!';
            }

            $this->closeModal();
            session()->flash('success', $message);
        } catch (\Exception $e) {
            session()->flash('error', 'Terjadi kesalahan: ' . $e->getMessage());
        }
    }

    public function confirmDelete($userId)
    {
        $this->userToDelete = User::find($userId);
        $this->showDeleteModal = true;
    }

    public function delete()
    {
        // Cek permission users.delete (sesuai dengan RoleSeeder)
        if (!auth()->user()->can('users.delete')) {
            session()->flash('error', 'Anda tidak memiliki izin untuk menghapus user.');
            $this->closeDeleteModal();
            return;
        }

        try {
            if ($this->userToDelete) {
                // Cek apakah user mencoba menghapus akun sendiri
                if ($this->userToDelete->id === auth()->id()) {
                    session()->flash('error', 'Anda tidak dapat menghapus akun Anda sendiri!');
                    return;
                }

                // Log aktivitas sebelum menghapus
                activity()
                    ->causedBy(auth()->user())
                    ->performedOn($this->userToDelete)
                    ->withProperties([
                        'user_name' => $this->userToDelete->name,
                        'user_email' => $this->userToDelete->email,
                    ])
                    ->log('Menghapus user');

                $this->userToDelete->delete();
                session()->flash('message', 'User berhasil dihapus!');
            }
        } catch (\Exception $e) {
            session()->flash('error', 'Terjadi kesalahan: ' . $e->getMessage());
        } finally {
            $this->closeDeleteModal();
        }
    }

    public function closeModal()
    {
        $this->showModal = false;
        $this->resetForm();
    }

    public function closeDeleteModal()
    {
        $this->showDeleteModal = false;
        $this->userToDelete = null;
    }

    public function showImportUsers()
    {
        // Calculate import counts
        $this->calculateImportCounts();
        
        $this->showImportModal = true;
        $this->importProgress = 0;
        $this->importResults = [];
    }
    
    public function calculateImportCounts()
    {
        // Count employees that can be imported
        $employeesTotal = Employee::whereNotNull('nip')
                                ->where('nip', '!=', '')
                                ->where('status_aktif', 'Aktif')
                                ->count();
        
        $employeesExisting = Employee::whereNotNull('nip')
                                   ->where('nip', '!=', '')
                                   ->where('status_aktif', 'Aktif')
                                   ->whereExists(function($query) {
                                       $query->select(DB::raw(1))
                                            ->from('users')
                                            ->whereRaw('users.nip = employees.nip');
                                   })
                                   ->count();
        
        $employeesNew = $employeesTotal - $employeesExisting;
        
        // Count dosens that can be imported
        $dosensTotal = Dosen::whereNotNull('nip')
                           ->where('nip', '!=', '')
                           ->where('status_aktif', 'Aktif')
                           ->count();
        
        $dosensExisting = Dosen::whereNotNull('nip')
                               ->where('nip', '!=', '')
                               ->where('status_aktif', 'Aktif')
                               ->whereExists(function($query) {
                                   $query->select(DB::raw(1))
                                        ->from('users')
                                        ->whereRaw('users.nip = dosens.nip');
                               })
                               ->count();
        
        $dosensNew = $dosensTotal - $dosensExisting;
        
        $this->importCounts = [
            'employees_total' => $employeesTotal,
            'employees_existing' => $employeesExisting,
            'employees_new' => $employeesNew,
            'dosens_total' => $dosensTotal,
            'dosens_existing' => $dosensExisting,
            'dosens_new' => $dosensNew,
            'total_new' => $employeesNew + $dosensNew,
            'total_existing' => $employeesExisting + $dosensExisting
        ];
    }

    public function importUsers()
    {
        // Increase execution time limit for large imports
        set_time_limit(300); // 5 minutes
        ini_set('memory_limit', '256M'); // Increase memory limit
        
        try {
            DB::beginTransaction();
            
            $this->importResults = [
                'employees_imported' => 0,
                'dosens_imported' => 0,
                'employees_skipped' => 0,
                'dosens_skipped' => 0,
                'employees_updated' => 0,
                'dosens_updated' => 0,
                'errors' => []
            ];
            
            // Get staff role
            $staffRole = Role::where('name', 'staff')->first();
            if (!$staffRole) {
                throw new \Exception('Role "staff" tidak ditemukan. Pastikan role sudah dibuat.');
            }
            
            // Import Employees in batches
            $employees = Employee::whereNotNull('nip')
                                ->where('nip', '!=', '')
                                ->where('status_aktif', 'Aktif')
                                ->get();
            
            $this->importProgress = 10;
            $totalEmployees = $employees->count();
            $processedEmployees = 0;
            
            // Process employees in batches of 50
            foreach ($employees->chunk(50) as $batch) {
                foreach ($batch as $employee) {
                    try {
                        // Check if user already exists
                        $existingUser = User::where('nip', $employee->nip)->first();
                        
                        $name = trim($employee->nama_lengkap_with_gelar);
                        // Prioritize campus email over personal email
                        $email = $employee->email_kampus ?: ($employee->email ?: $employee->nip . '@usbypkp.ac.id');
                        
                        if ($existingUser) {
                            // Update existing user
                            $existingUser->update([
                                'name' => $name,
                                'email' => $email,
                                'employee_type' => 'employee',
                                'employee_id' => $employee->id,
                            ]);
                            
                            // Ensure user has staff role
                            if (!$existingUser->hasRole('staff')) {
                                $existingUser->assignRole('staff');
                            }
                            
                            $this->importResults['employees_updated']++;
                        } else {
                            // Create new user
                            $user = User::create([
                                'name' => $name,
                                'email' => $email,
                                'nip' => $employee->nip,
                                'password' => Hash::make('ypkp@#1234'),
                                'employee_type' => 'employee',
                                'employee_id' => $employee->id,
                                'email_verified_at' => now(),
                            ]);
                            
                            $user->assignRole('staff');
                            $this->importResults['employees_imported']++;
                        }
                        
                        $processedEmployees++;
                        
                        // Update progress more frequently
                        if ($processedEmployees % 10 == 0) {
                            $progress = 10 + (($processedEmployees / $totalEmployees) * 40);
                            $this->importProgress = min(50, $progress);
                        }
                        
                    } catch (\Exception $e) {
                        $this->importResults['employees_skipped']++;
                        $this->importResults['errors'][] = "Employee {$employee->nama_lengkap} (NIP: {$employee->nip}): " . $e->getMessage();
                    }
                }
                
                // Small delay between batches to prevent overwhelming the server
                usleep(10000); // 10ms delay
            }
            
            $this->importProgress = 50;
            
            // Import Dosens in batches
            $dosens = Dosen::whereNotNull('nip')
                          ->where('nip', '!=', '')
                          ->where('status_aktif', 'Aktif')
                          ->get();
            
            $totalDosens = $dosens->count();
            $processedDosens = 0;
            
            // Process dosens in batches of 50
            foreach ($dosens->chunk(50) as $batch) {
                foreach ($batch as $dosen) {
                    try {
                        // Check if user already exists
                        $existingUser = User::where('nip', $dosen->nip)->first();
                        
                        $name = trim($dosen->nama_lengkap_with_gelar);
                        // Prioritize campus email over personal email
                        $email = $dosen->email_kampus ?: ($dosen->email ?: $dosen->nip . '@usbypkp.ac.id');
                        
                        if ($existingUser) {
                            // Update existing user
                            $existingUser->update([
                                'name' => $name,
                                'email' => $email,
                                'employee_type' => 'dosen',
                                'employee_id' => $dosen->id,
                            ]);
                            
                            // Ensure user has staff role
                            if (!$existingUser->hasRole('staff')) {
                                $existingUser->assignRole('staff');
                            }
                            
                            $this->importResults['dosens_updated']++;
                        } else {
                            // Create new user
                            $user = User::create([
                                'name' => $name,
                                'email' => $email,
                                'nip' => $dosen->nip,
                                'password' => Hash::make('ypkp@#1234'),
                                'employee_type' => 'dosen',
                                'employee_id' => $dosen->id,
                                'email_verified_at' => now(),
                            ]);
                            
                            $user->assignRole('staff');
                            $this->importResults['dosens_imported']++;
                        }
                        
                        $processedDosens++;
                        
                        // Update progress more frequently
                        if ($processedDosens % 10 == 0) {
                            $progress = 50 + (($processedDosens / $totalDosens) * 50);
                            $this->importProgress = min(100, $progress);
                        }
                        
                    } catch (\Exception $e) {
                        $this->importResults['dosens_skipped']++;
                        $this->importResults['errors'][] = "Dosen {$dosen->nama} (NIP: {$dosen->nip}): " . $e->getMessage();
                    }
                }
                
                // Small delay between batches
                usleep(10000); // 10ms delay
            }
            
            $this->importProgress = 100;
            
            DB::commit();
            
            $totalImported = $this->importResults['employees_imported'] + $this->importResults['dosens_imported'];
            $totalUpdated = $this->importResults['employees_updated'] + $this->importResults['dosens_updated'];
            
            session()->flash('success', "Import berhasil! {$totalImported} pengguna baru dibuat, {$totalUpdated} pengguna diperbarui.");
            
        } catch (\Exception $e) {
            DB::rollBack();
            $this->importResults['errors'][] = $e->getMessage();
            session()->flash('error', 'Terjadi kesalahan saat import: ' . $e->getMessage());
        }
    }
    
    public function closeImportModal()
    {
        $this->showImportModal = false;
        $this->importProgress = 0;
        $this->importResults = [];
        $this->importCounts = [];
    }

    private function resetForm()
    {
        $this->userId = null;
        $this->name = '';
        $this->email = '';
        $this->password = '';
        $this->password_confirmation = '';
        $this->selectedRoles = [];
        $this->resetErrorBag();
    }

    public function render()
    {
        $query = User::query();

        if ($this->search) {
            $query->where(function ($q) {
                $q->where('name', 'like', '%' . $this->search . '%')
                  ->orWhere('email', 'like', '%' . $this->search . '%');
            });
        }

        if ($this->selectedRole) {
            $query->whereHas('roles', function ($q) {
                $q->where('name', $this->selectedRole);
            });
        }

        $users = $query->with('roles')->latest()->paginate(10);
        $roles = Role::all();

        return view('livewire.superadmin.user-management', [
            'users' => $users,
            'roles' => $roles,
            'allRoles' => Role::all()
        ]);
    }
}
